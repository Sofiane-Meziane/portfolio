---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { i18n, defaultLang, isLang } from "../../../lib/i18n";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => {
    const [lang, ...rest] = project.slug.split("/");
    return {
      params: { lang, slug: rest.join("/") },
      props: { project, lang }
    };
  });
}

const { project, lang: rawLang } = Astro.props;
const lang = isLang(rawLang) ? rawLang : defaultLang;
const t = i18n[lang];
const { Content } = await project.render();
const dateLocale = lang === "fr" ? "fr-FR" : "en-US";
const dateLabel = new Intl.DateTimeFormat(dateLocale, {
  year: "numeric",
  month: "long",
  day: "numeric"
}).format(project.data.date);
---

<BaseLayout lang={lang} title={`${project.data.title} | ${t.siteName}`} description={project.data.summary}>
  <section class="pt-10">
    <a href={`/${lang}/projects`} class="text-sm font-semibold text-sea hover:text-ink">{t.backToProjects}</a>
    <div class="mt-6 grid gap-10 lg:grid-cols-[2fr,1fr]">
      <article class="glass p-8">
        <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.2em] text-ink/60">
          <span>{dateLabel}</span>
          {project.data.dataset ? <span>{t.datasetLabel}: {project.data.dataset}</span> : null}
        </div>
        <h1 class="mt-4 text-4xl font-display">{project.data.title}</h1>
        <p class="mt-4 text-lg text-ink/80">{project.data.summary}</p>
        <div class="prose prose-neutral dark:prose-invert mt-8 max-w-none prose-headings:font-display">
          <Content />
        </div>
      </article>
      <aside class="space-y-6">
        <div class="card">
          <p class="text-xs uppercase tracking-[0.2em] text-ink/60">{t.keyLinks}</p>
          <div class="mt-3 flex flex-col gap-3 text-sm font-semibold text-sea">
            {project.data.repo ? (
              <a href={project.data.repo} target="_blank" rel="noreferrer">{t.repoLabel}</a>
            ) : (
              <span class="text-ink/50">{t.repoMissing}</span>
            )}
            {project.data.demo ? (
              <a href={project.data.demo} target="_blank" rel="noreferrer">{t.demoLabel}</a>
            ) : null}
          </div>
        </div>
        <div class="card">
          <p class="text-xs uppercase tracking-[0.2em] text-ink/60">{t.tagsLabel}</p>
          <div class="mt-3 flex flex-wrap gap-2">
            {project.data.tags.map((tag) => (
              <span class="pill">{tag}</span>
            ))}
          </div>
        </div>
      </aside>
    </div>
  </section>
</BaseLayout>