---
import "../styles/global.css";
import { i18n, defaultLang, isLang } from "../lib/i18n";

const { title, description, lang: langProp } = Astro.props;
const lang = isLang(langProp) ? langProp : defaultLang;
const t = i18n[lang];

const pageTitle = title ?? `${t.siteName} | ${t.siteTitle}`;
const pageDescription = description ?? t.siteDescription;

const otherLang = lang === "en" ? "fr" : "en";
const path = Astro.url.pathname;
let switchHref = `/${otherLang}/`;
if (path === `/${lang}` || path === `/${lang}/`) {
  switchHref = `/${otherLang}/`;
} else if (path.startsWith(`/${lang}/`)) {
  switchHref = path.replace(`/${lang}/`, `/${otherLang}/`);
}

const nav = [
  { href: `/${lang}/`, label: t.navHome },
  { href: `/${lang}/projects`, label: t.navProjects },
  { href: `/${lang}/#about`, label: t.navAbout },
  { href: `/${lang}/#contact`, label: t.navContact }
];
---
<!doctype html>
<html lang={lang} data-lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Spectral:wght@400;500;600;700&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Spectral:wght@400;500;600;700&display=swap"
        rel="stylesheet"
      />
    </noscript>
    <script is:inline>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.dataset.theme = theme;
        } catch (err) {
          // ignore
        }
      })();
    </script>
  </head>
  <body class="text-ink antialiased">
    <div class="relative min-h-screen overflow-hidden">
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -top-32 -left-24 h-80 w-80 rounded-full bg-sun/40 blur-3xl animate-float-slow"></div>
        <div class="absolute top-10 right-0 h-72 w-72 rounded-full bg-sea/30 blur-3xl"></div>
        <div class="absolute bottom-0 left-1/3 h-64 w-64 rounded-full bg-clay/25 blur-3xl"></div>
        <div class="absolute inset-0 grid-lines"></div>
      </div>

      <header class="relative z-20">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-8">
          <a href={`/${lang}/`} class="font-display text-2xl font-bold tracking-tight text-ink">{t.siteName}</a>
          <nav class="flex items-center gap-6 text-[0.7rem] font-bold uppercase tracking-[0.2em] text-ink/60">
            {nav.map((item) => (
              <a
                href={item.href}
                class="transition hover:text-ink hover:translate-y-[-1px]"
                target={item.external ? "_blank" : undefined}
                rel={item.external ? "noreferrer" : undefined}
              >
                {item.label}
              </a>
            ))}
            <div class="flex items-center gap-3 ml-2 border-l border-ink/10 pl-5">
              <button
                type="button"
                class="theme-toggle"
                aria-label={t.themeDarkAria}
              >
                <svg class="sun-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
                </svg>
                <svg class="moon-icon hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
              </button>
              <a href={switchHref} class="lang-toggle" aria-label={t.toggleAria}>
                {lang === "fr" ? "EN" : "FR"}
              </a>
            </div>
          </nav>
        </div>
      </header>

      <main class="relative z-10 mx-auto w-full max-w-6xl px-6 pb-10">
        <slot />
      </main>

      <footer class="relative z-10 border-t border-ink/5 mt-0">
        <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-6 py-10 text-xs font-medium text-ink/50 tracking-wide">
          <span>{t.footerCopyright}</span>
          <span>{t.footerRights}</span>
        </div>
      </footer>
    </div>

    <script is:inline>
      try {
        localStorage.setItem("lang", {JSON.stringify(lang)});
      } catch (err) {
        // ignore
      }
    </script>
    <script is:inline>
      (function () {
        const root = document.documentElement;
        const button = document.querySelector(".theme-toggle");
        if (!button) return;
        
        const sunIcon = button.querySelector(".sun-icon");
        const moonIcon = button.querySelector(".moon-icon");

        const applyTheme = (theme) => {
          root.dataset.theme = theme;
          if (theme === "dark") {
            sunIcon.classList.remove("hidden");
            moonIcon.classList.add("hidden");
          } else {
            sunIcon.classList.add("hidden");
            moonIcon.classList.remove("hidden");
          }
          button.setAttribute("data-theme", theme);
        };

        let stored = null;
        try {
          stored = localStorage.getItem("theme");
        } catch (err) {
          // ignore
        }

        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(stored || (prefersDark ? "dark" : "light"));

        button.addEventListener("click", () => {
          const next = root.dataset.theme === "dark" ? "light" : "dark";
          applyTheme(next);
          try {
            localStorage.setItem("theme", next);
          } catch (err) {
            // ignore
          }
        });
      })();
    </script>
  </body>
</html>